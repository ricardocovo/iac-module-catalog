name: Continous Integration

on:
  push:
    branches:
      - main
    paths:
      - 'catalog/**/*.bicep'
      - 'catalog/**/*.bicepparam'
      - '.github/workflows/ci.yml'
  pull_request:
    branches:
      - main
    paths:
      - 'catalog/**/*.bicep'
      - 'catalog/**/*.bicepparam'
      - '.github/workflows/ci.yml'
  workflow_dispatch:
    inputs:
      changed_only:
        description: 'Only validate new and updated modules (based on git diff)'
        required: false
        default: true
        type: boolean

# Security: Default to read-only permissions
permissions:
  contents: read
  pull-requests: read

# Cancel outdated PR builds
concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

env:
  # Updated to latest stable Bicep CLI version
  BICEP_VERSION: '0.32.4'

jobs:
  lint-and-build:
    name: Lint and Build Bicep Modules
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Cache Bicep CLI
        id: cache-bicep
        uses: actions/cache@v4
        with:
          path: /usr/local/bin/bicep
          key: bicep-${{ runner.os }}-${{ env.BICEP_VERSION }}

      - name: Install Bicep CLI
        if: steps.cache-bicep.outputs.cache-hit != 'true'
        run: |
          set -euo pipefail
          
          echo "Installing Bicep CLI version ${{ env.BICEP_VERSION }}"
          
          # Install specific version of Bicep
          curl -fsSL -o bicep https://github.com/Azure/bicep/releases/download/v${{ env.BICEP_VERSION }}/bicep-linux-x64
          chmod +x ./bicep
          sudo mv ./bicep /usr/local/bin/bicep
          
          # Verify installation
          bicep --version

      - name: Verify Bicep CLI
        run: bicep --version

      - name: Find all main.bicep modules
        id: find-modules
        run: |
          set -euo pipefail
          
          # Determine if we should only check changed files
          # - For workflow_dispatch: use the input value
          # - For push/pull_request: always check only changed files
          event_name="${{ github.event_name }}"
          changed_only_input="${{ inputs.changed_only }}"
          
          if [[ "$event_name" == "workflow_dispatch" ]]; then
            changed_only="$changed_only_input"
          else
            # For push and pull_request, always check only changed files
            changed_only="true"
          fi
          
          echo "Event: $event_name, Changed only: $changed_only"
          
          if [[ "$changed_only" == "true" ]]; then
            echo "üîç Finding only changed main.bicep modules..."
            
            # Get the base ref for comparison
            if [[ "$event_name" == "pull_request" ]]; then
              base_ref="origin/${{ github.base_ref }}"
              echo "Comparing against PR base: $base_ref"
            else
              # For push, compare with the before commit if available
              before_sha="${{ github.event.before }}"
              if [[ -n "$before_sha" && "$before_sha" != "0000000000000000000000000000000000000000" ]]; then
                base_ref="$before_sha"
                echo "Comparing against previous commit: $base_ref"
              else
                # Fallback to HEAD~1
                base_ref="HEAD~1"
                echo "Comparing against HEAD~1"
              fi
            fi
            
            # Find changed bicep files that are main.bicep
            modules=$(git diff --name-only --diff-filter=ACMR "$base_ref" HEAD -- 'catalog/**/main.bicep' 2>/dev/null | sort || echo "")
            
            if [[ -z "$modules" ]]; then
              echo "‚ÑπÔ∏è  No changed main.bicep modules found in this commit/PR"
              echo "No modules to validate - exiting successfully"
              touch /tmp/modules.txt
              exit 0
            fi
          else
            echo "üîç Discovering all main.bicep modules in catalog/"
            modules=$(find catalog -type f -name "main.bicep" | sort)
          fi
          
          if [[ -z "$modules" ]]; then
            echo "‚ùå No main.bicep modules found"
            exit 1
          fi
          
          module_count=$(echo "$modules" | wc -l)
          echo "‚úÖ Found $module_count modules to validate"
          echo "$modules"
          
          # Save for next step
          echo "$modules" > /tmp/modules.txt

      - name: Lint Bicep modules
        id: lint
        continue-on-error: true
        run: |
          set -euo pipefail
          
          # Check if there are modules to process
          if [[ ! -s /tmp/modules.txt ]]; then
            echo "‚ÑπÔ∏è  No modules to lint"
            mkdir -p /tmp/results
            echo "module|lint_status" > /tmp/results/lint_results.txt
            exit 0
          fi
          
          echo "üîç Linting Bicep modules..."
          
          failed_modules=()
          passed_count=0
          failed_count=0
          
          # Create results file
          mkdir -p /tmp/results
          echo "module|lint_status" > /tmp/results/lint_results.txt
          
          while IFS= read -r module; do
            echo ""
            echo "Linting: $module"
            
            if bicep lint "$module" --diagnostics-format sarif > /dev/null 2>&1; then
              echo "  ‚úÖ Passed"
              echo "$module|‚úÖ Pass" >> /tmp/results/lint_results.txt
              passed_count=$((passed_count + 1))
            else
              echo "  ‚ùå Failed"
              echo "$module|‚ùå Fail" >> /tmp/results/lint_results.txt
              failed_modules+=("$module")
              failed_count=$((failed_count + 1))
              
              # Show detailed error
              bicep lint "$module" || true
            fi
          done < /tmp/modules.txt
          
          echo ""
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo "Lint Summary:"
          echo "  ‚úÖ Passed: $passed_count"
          echo "  ‚ùå Failed: $failed_count"
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          
          if [[ ${#failed_modules[@]} -gt 0 ]]; then
            echo ""
            echo "Failed modules:"
            printf '  - %s\n' "${failed_modules[@]}"
            exit 1
          fi

      - name: Build Bicep modules
        id: build
        continue-on-error: true
        run: |
          set -euo pipefail
          
          echo "üî® Building Bicep modules..."
          
          # Check if there are modules to build
          if [[ ! -s /tmp/modules.txt ]]; then
            echo "‚ÑπÔ∏è No modules to build"
            echo "module|build_status" > /tmp/results/build_results.txt
            exit 0
          fi
          
          failed_modules=()
          passed_count=0
          failed_count=0
          
          # Create results file
          echo "module|build_status" > /tmp/results/build_results.txt
          
          while IFS= read -r module; do
            echo ""
            echo "Building: $module"
            
            module_dir=$(dirname "$module")
            output_file="$module_dir/main.json"
            
            if bicep build "$module" --outfile "$output_file"; then
              echo "  ‚úÖ Built successfully"
              echo "$module|‚úÖ Pass" >> /tmp/results/build_results.txt
              passed_count=$((passed_count + 1))
              
              # Verify output exists
              if [[ ! -f "$output_file" ]]; then
                echo "  ‚ö†Ô∏è  Warning: Output file not created"
              fi
            else
              echo "  ‚ùå Build failed"
              echo "$module|‚ùå Fail" >> /tmp/results/build_results.txt
              failed_modules+=("$module")
              failed_count=$((failed_count + 1))
            fi
          done < /tmp/modules.txt
          
          echo ""
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo "Build Summary:"
          echo "  ‚úÖ Passed: $passed_count"
          echo "  ‚ùå Failed: $failed_count"
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          
          if [[ ${#failed_modules[@]} -gt 0 ]]; then
            echo ""
            echo "Failed modules:"
            printf '  - %s\n' "${failed_modules[@]}"
            exit 1
          fi

      - name: Publish Results Summary
        if: always()
        run: |
          set -euo pipefail
          
          echo "üìä Generating CI Results Summary..."
          
          # Start the summary
          {
            echo "## üîç Bicep Module Validation Results"
            echo ""
            
            # Check if there are modules to report
            if [[ ! -s /tmp/modules.txt ]]; then
              echo "‚ÑπÔ∏è **No modules were validated in this run.**"
              echo ""
              echo "This may be because:"
              echo "- No Bicep modules were changed in this commit"
              echo "- The \`changed_only\` option was enabled and no changes were detected"
            else
              echo "| Module | Lint | Build |"
              echo "|--------|------|-------|"
              
              # Merge results from both files
              while IFS= read -r module; do
                # Get lint result
                lint_result=$(grep "^$module|" /tmp/results/lint_results.txt 2>/dev/null | cut -d'|' -f2 || echo "‚ö†Ô∏è Skipped")
                
                # Get build result
                build_result=$(grep "^$module|" /tmp/results/build_results.txt 2>/dev/null | cut -d'|' -f2 || echo "‚ö†Ô∏è Skipped")
                
                # Format module path for display
                module_display=$(echo "$module" | sed 's|catalog/||')
                
                echo "| \`$module_display\` | $lint_result | $build_result |"
              done < /tmp/modules.txt
            fi
            
            echo ""
            echo "---"
            echo ""
            echo "**Workflow:** \`${{ github.workflow }}\`  "
            echo "**Run:** [#${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})  "
            echo "**Triggered by:** ${{ github.event_name }}  "
            echo "**Commit:** [\`${GITHUB_SHA:0:7}\`](${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }})  "
          } >> "$GITHUB_STEP_SUMMARY"
          
          echo "‚úÖ Summary published"

      - name: Check for failures
        if: always()
        run: |
          echo "Checking step results..."
          
          failed=false
          
          if [[ "${{ steps.lint.outcome }}" == "failure" ]]; then
            echo "‚ùå Lint step failed"
            failed=true
          fi
          
          if [[ "${{ steps.build.outcome }}" == "failure" ]]; then
            echo "‚ùå Build step failed"
            failed=true
          fi
          
          if [[ "$failed" == "true" ]]; then
            echo ""
            echo "One or more validation steps failed. See summary for details."
            exit 1
          fi
          
          echo "‚úÖ All validation steps passed"
