name: Module Request Triage

on:
  issues:
    types: [opened]

permissions:
  contents: read

jobs:
  triage-module-request:
    name: Process Module Request
    runs-on: ubuntu-latest
    if: contains(github.event.issue.title, 'Module Request')
    permissions:
      contents: read
      issues: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Extract module name from issue title
        id: extract
        env:
          ISSUE_TITLE: ${{ github.event.issue.title }}
        run: |
          echo "Original title: $ISSUE_TITLE"
          
          # Extract module path after "Module Request:" or "Module Request -"
          MODULE_PATH=$(echo "$ISSUE_TITLE" | sed -n 's/.*[Mm]odule [Rr]equest[:\-]\s*\(.*\)/\1/p' | xargs)
          
          if [ -z "$MODULE_PATH" ]; then
            echo "status=invalid" >> $GITHUB_OUTPUT
            echo "message=‚ùå **Invalid Format**: Could not extract module name from issue title. Please use format: \`Module Request: category/module-name\`" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "module_path=$MODULE_PATH" >> $GITHUB_OUTPUT
          echo "Extracted module path: $MODULE_PATH"
          
          # Split into category and module name
          CATEGORY=$(echo "$MODULE_PATH" | cut -d'/' -f1)
          MODULE_NAME=$(echo "$MODULE_PATH" | cut -d'/' -f2)
          
          echo "category=$CATEGORY" >> $GITHUB_OUTPUT
          echo "module_name=$MODULE_NAME" >> $GITHUB_OUTPUT
          echo "Category: $CATEGORY, Module: $MODULE_NAME"
      
      - name: Check if module exists in local catalog
        id: check_local
        if: steps.extract.outputs.status != 'invalid'
        run: |
          MODULE_PATH="${{ steps.extract.outputs.module_path }}"
          CATALOG_PATH="catalog/$MODULE_PATH"
          
          if [ -d "$CATALOG_PATH" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Module exists locally at: $CATALOG_PATH"
            
            # Find all versions
            VERSIONS=$(find "$CATALOG_PATH" -maxdepth 1 -type d -name "v*" -o -name "[0-9]*" | sort -V | xargs -n1 basename | tr '\n' ', ' | sed 's/,$//')
            if [ -z "$VERSIONS" ]; then
              VERSIONS=$(find "$CATALOG_PATH" -maxdepth 1 -type d | grep -E '/[0-9]+\.[0-9]+\.[0-9]+$' | xargs -n1 basename | sort -V | tr '\n' ', ' | sed 's/,$//')
            fi
            
            echo "versions=$VERSIONS" >> $GITHUB_OUTPUT
            echo "Available versions: $VERSIONS"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "‚ùå Module does not exist locally"
          fi
      
      - name: Check if module exists in AVM Registry
        id: check_avm
        if: steps.extract.outputs.status != 'invalid' && steps.check_local.outputs.exists == 'false'
        run: |
          MODULE_PATH="${{ steps.extract.outputs.module_path }}"
          CATEGORY="${{ steps.extract.outputs.category }}"
          MODULE_NAME="${{ steps.extract.outputs.module_name }}"
          
          # Download AVM module indexes
          echo "Checking AVM Bicep Resource Modules..."
          curl -sSL -o resource-modules.csv "https://raw.githubusercontent.com/Azure/Azure-Verified-Modules/refs/heads/main/docs/static/module-indexes/BicepResourceModules.csv"
          
          echo "Checking AVM Bicep Pattern Modules..."
          curl -sSL -o pattern-modules.csv "https://raw.githubusercontent.com/Azure/Azure-Verified-Modules/refs/heads/main/docs/static/module-indexes/BicepPatternModules.csv"
          
          # Check resource modules (avm/res/*)
          if grep -qi "avm/res/$MODULE_PATH" resource-modules.csv; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "type=resource" >> $GITHUB_OUTPUT
            
            # Extract module details from CSV
            MODULE_INFO=$(grep -i "avm/res/$MODULE_PATH" resource-modules.csv | head -n1)
            MODULE_FULL_NAME=$(echo "$MODULE_INFO" | cut -d',' -f1 | tr -d '"')
            
            echo "module_name=$MODULE_FULL_NAME" >> $GITHUB_OUTPUT
            echo "registry_path=br/public:$MODULE_FULL_NAME" >> $GITHUB_OUTPUT
            echo "docs_url=https://github.com/Azure/bicep-registry-modules/tree/main/$MODULE_FULL_NAME" >> $GITHUB_OUTPUT
            
            echo "‚úÖ Found in AVM Resource Modules: $MODULE_FULL_NAME"
            exit 0
          fi
          
          # Check pattern modules (avm/ptn/*)
          if grep -qi "avm/ptn/$MODULE_PATH" pattern-modules.csv; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "type=pattern" >> $GITHUB_OUTPUT
            
            # Extract module details from CSV
            MODULE_INFO=$(grep -i "avm/ptn/$MODULE_PATH" pattern-modules.csv | head -n1)
            MODULE_FULL_NAME=$(echo "$MODULE_INFO" | cut -d',' -f1 | tr -d '"')
            
            echo "module_name=$MODULE_FULL_NAME" >> $GITHUB_OUTPUT
            echo "registry_path=br/public:$MODULE_FULL_NAME" >> $GITHUB_OUTPUT
            echo "docs_url=https://github.com/Azure/bicep-registry-modules/tree/main/$MODULE_FULL_NAME" >> $GITHUB_OUTPUT
            
            echo "‚úÖ Found in AVM Pattern Modules: $MODULE_FULL_NAME"
            exit 0
          fi
          
          # Module not found in AVM
          echo "exists=false" >> $GITHUB_OUTPUT
          echo "‚ùå Module not found in AVM registry"
      
      - name: Add comment - Module exists in catalog
        if: steps.check_local.outputs.exists == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const modulePath = '${{ steps.extract.outputs.module_path }}';
            const versions = '${{ steps.check_local.outputs.versions }}';
            
            const comment = `## ‚úÖ Module Already Exists in Catalog
            
            The requested module **\`${modulePath}\`** is already available in this repository's catalog.
            
            ### üìç Location
            - **Path**: [\`catalog/${modulePath}/\`](https://github.com/${{ github.repository }}/tree/main/catalog/${modulePath})
            
            ### üì¶ Available Versions
            ${versions || 'Version information not available'}
            
            ### üìö Next Steps
            - Review the [module documentation](https://github.com/${{ github.repository }}/tree/main/catalog/${modulePath}/README.md)
            - Check the latest version for usage examples
            - If you need a different version, please specify in this issue
            
            ---
            *This issue will be labeled as \`module-exists\` and can be closed.*`;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: comment
            });
            
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: ['module-exists', 'triage-complete']
            });
      
      - name: Add comment - Module exists in AVM
        if: steps.check_local.outputs.exists == 'false' && steps.check_avm.outputs.exists == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const modulePath = '${{ steps.extract.outputs.module_path }}';
            const avmModuleName = '${{ steps.check_avm.outputs.module_name }}';
            const registryPath = '${{ steps.check_avm.outputs.registry_path }}';
            const docsUrl = '${{ steps.check_avm.outputs.docs_url }}';
            const moduleType = '${{ steps.check_avm.outputs.type }}';
            
            const comment = `## üîç Module Found in Azure Verified Modules (AVM)
            
            The requested module **\`${modulePath}\`** is not in our local catalog, but it exists in the **Azure Verified Modules** registry.
            
            ### üì¶ AVM Module Information
            - **Type**: ${moduleType === 'resource' ? 'Resource Module' : 'Pattern Module'}
            - **Full Name**: \`${avmModuleName}\`
            - **Registry Path**: \`${registryPath}:VERSION\`
            - **Documentation**: [${avmModuleName}](${docsUrl})
            
            ### üöÄ Usage
            You can use this module directly from the AVM registry:
            
            \`\`\`bicep
            module ${modulePath.split('/')[1]} '${registryPath}:0.1.0' = {
              name: 'deployment-name'
              params: {
                // Add required parameters
              }
            }
            \`\`\`
            
            ### üìã Next Steps
            - **Option 1**: Use the module directly from AVM registry (recommended)
            - **Option 2**: Request we add a customized version to our catalog
            
            If you need a customized version in our catalog, please comment with specific requirements.
            
            ---
            *This issue has been labeled as \`module-available-avm\`. Let us know if you need this added to our catalog.*`;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: comment
            });
            
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: ['module-available-avm', 'triage-complete']
            });
      
      - name: Add comment - Module not found
        if: steps.check_local.outputs.exists == 'false' && steps.check_avm.outputs.exists == 'false' && steps.extract.outputs.status != 'invalid'
        uses: actions/github-script@v7
        with:
          script: |
            const modulePath = '${{ steps.extract.outputs.module_path }}';
            
            const comment = `## ‚ùå Module Not Found
            
            The requested module **\`${modulePath}\`** was not found in:
            - ‚ùå Our local catalog
            - ‚ùå Azure Verified Modules (AVM) registry
            
            ### üîç Verification
            We checked:
            - Local catalog path: \`catalog/${modulePath}/\`
            - AVM Resource Modules: \`avm/res/${modulePath}\`
            - AVM Pattern Modules: \`avm/ptn/${modulePath}\`
            
            ### üìã Next Steps
            1. **Double-check the module path** - Verify the correct category and module name
            2. **Browse available modules**:
               - [Our Catalog](https://github.com/${{ github.repository }}/tree/main/catalog)
               - [AVM Bicep Registry](https://github.com/Azure/bicep-registry-modules/tree/main/avm)
            3. **Custom module request** - If this is a custom module, please provide:
               - Azure resource type
               - Specific requirements
               - Use case description
            
            ### üí° Common Module Paths
            Examples of valid paths:
            - \`network/virtual-network\`
            - \`storage/storage-account\`
            - \`compute/app-service\`
            - \`security/key-vault\`
            
            ---
            *This issue has been labeled as \`module-not-found\`. Please update with correct information or provide custom requirements.*`;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: comment
            });
            
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: ['module-not-found', 'needs-clarification']
            });
      
      - name: Add comment - Invalid format
        if: steps.extract.outputs.status == 'invalid'
        uses: actions/github-script@v7
        env:
          ISSUE_TITLE: ${{ github.event.issue.title }}
        with:
          script: |
            const issueTitle = process.env.ISSUE_TITLE;
            const comment = `## ‚ùå Invalid Module Request Format
            
            Could not extract the module name from the issue title.
            
            ### üìã Required Format
            Please update the issue title to follow this format:
            
            \`\`\`
            Module Request: category/module-name
            \`\`\`
            
            ### ‚úÖ Valid Examples
            - \`Module Request: network/virtual-network\`
            - \`Module Request: storage/storage-account\`
            - \`Module Request: compute/app-service\`
            - \`Module Request - security/key-vault\` (dash also works)
            
            ### üìö Available Categories
            Browse our catalog to see available categories:
            - [Catalog Structure](https://github.com/${{ github.repository }}/tree/main/catalog)
            
            ---
            *Please update the issue title and we'll automatically re-check. Current title: "${issueTitle}"*`;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: comment
            });
            
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: ['invalid-format', 'needs-update']
            });

concurrency:
  group: module-request-${{ github.event.issue.number }}
  cancel-in-progress: false
